<script src="lib/system.src.js"></script>
<script>
System.register("foo", [], function(_export) {
	var __moduleName = "foo";
	
	function foo(str) {
		return str + '!';
	}
	return {
		setters: [function (m) {
		}],
		execute: function () {
			_export("default", foo);
		}
	};
});

System.register("bar", ["foo"], function(_export) {
	"use strict";

	var __moduleName = "bar";

	var foo;
	function bar() {
		return foo("foobar");
	}
	return {
		setters: [function (m) {
			foo = m.default;
		}],
		execute: function () {
			_export("bar", bar);
		}
	};
});

System.import('bar').then(function(module) {
	var bar = module.bar;
	console.log(bar()); // Note: displays 'foobar!'
	doFooReplacementTest();
});

function doFooReplacementTest() {
	// replace 'foo' and verify it's been replaced
	System.set('foo', System.newModule({default: function foo(str) {
		return str + '?';
	}}));
	
	System.import('foo').then(function(module) {
		var foo = module.default;
		console.log(foo('hello')); // Note: displays 'hello?'
	});
	
	
	// replace 'bar' and verify that it uses the new 'foo'
	System.set('bar', System.newModule(System.get('bar')));
	// System.set('bar', System.newModule({bar: System.get('bar').bar}));
	
	System.import('bar').then(function(module) {
		var bar = module.bar;
		console.log(bar()); // Note: displays 'foobar!' rather than 'foobar?' as desired
	});
}
</script>
